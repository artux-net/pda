name: Preview Build

on:
  issue_comment:
    types: [ created ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: Internal build
    runs-on: ubuntu-20.04
    if: >-
      github.event.issue.pull_request != '' && 
      (
        contains(github.event.comment.body, '/preview') || 
        contains(github.event.comment.body, '/build')
      )
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{secrets.token}}
          submodules: recursive
          fetch-depth: 0

      - name: Build & Deploy
        uses: ./.github/assembly
        id: assembly
        with:
          profile: preview
          signing_key: ${{ secrets.SIGNING_KEY }}
          key_alias: ${{ secrets.KEY_ALIAS }}
          keystore_password: ${{ secrets.KEYSTORE_PASSWORD }}
          key_password: ${{ secrets.KEY_PASSWORD }}
          service_account_json: ${{ secrets.SERVICE_ACCOUNT_JSON }}

      - name: Calculate expiration date
        id: expiration
        run: |
          expiration_date=$(date -d "+3 months" +"%d.%m.%Y")
          echo "expiration_date=$expiration_date" >> $GITHUB_OUTPUT
          echo "$expiration_date - Ссылка для скачивания действительна до этой даты"

      - name: Send message to Artux channel
        uses: ./.github/notify
        with:
          to: ${{ secrets.TELEGRAM_TO }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: |
            Preview сборка [${{ github.event.issue.pull_request.id }}](${{ github.event.issue.pull_request.html_url }})
            Код ${{ steps.assembly.outputs.versionCode }}, версия ${{ steps.assembly.outputs.versionName }}, активна до ${{ steps.expiration.outputs.expiration_date }}
            
            Автор: ${{ github.actor }}
            
            [Ссылка для скачивания](${{ steps.assembly.outputs.internalSharingDownloadUrl }})
            
            [Crashlytics](https://console.firebase.google.com/project/${{ vars.FIREBASE_ID }}/crashlytics/app/android:${{ vars.PACKAGE }}/issues?state=open&time=last-seven-days&types=crash&tag=all&sort=eventCount&versions=${{ steps.assembly.outputs.versionName }})
